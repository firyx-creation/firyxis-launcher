<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<title>Firyxis Launcher</title>
<script src="firebase-config.js"></script>
<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Rajdhani:wght@400;600;700&family=Inter:wght@300;400;500&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0a0a0c;--surface:#111116;--card:#16161e;--card2:#1c1c26;
  --border:rgba(255,255,255,0.07);--accent:#ff3c00;--accent2:#ff7a3c;
  --text:#e8e8f0;--muted:#6b6b80;--success:#00e676;--warning:#ffd740;
  --error:#f44336;--info:#2196f3;--sidebar-w:220px;--community-w:280px;
}
body{font-family:'Rajdhani',sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden;display:flex;flex-direction:column;user-select:none}

/* ‚îÄ‚îÄ Auth overlay ‚îÄ‚îÄ */
#auth-overlay{position:fixed;inset:0;background:radial-gradient(ellipse at 30% 50%,#1a0a00 0%,#0a0a0c 60%);z-index:5000;display:flex;align-items:center;justify-content:center}
#auth-overlay.hidden{display:none}
.auth-box{width:420px;background:var(--card);border:1px solid rgba(255,60,0,.2);border-radius:16px;overflow:hidden;box-shadow:0 40px 80px rgba(0,0,0,.6)}
.auth-header{padding:32px 32px 24px;text-align:center;background:linear-gradient(180deg,rgba(255,60,0,.08),transparent)}
.auth-logo{font-family:'Bebas Neue';font-size:28px;letter-spacing:4px;background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:4px}
.auth-subtitle{font-size:13px;color:var(--muted);font-family:'Inter'}
.auth-tabs{display:flex;border-bottom:1px solid var(--border)}
.auth-tab{flex:1;padding:14px;text-align:center;cursor:pointer;font-size:14px;font-weight:700;letter-spacing:1px;color:var(--muted);border:none;background:none;transition:all .15s}
.auth-tab.active{color:var(--accent2);border-bottom:2px solid var(--accent)}
.auth-body{padding:28px 32px}
.auth-field{margin-bottom:16px}
.auth-label{font-size:11px;letter-spacing:1.5px;color:var(--muted);text-transform:uppercase;margin-bottom:6px;display:block}
.auth-input{width:100%;background:var(--surface);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'Rajdhani';font-size:15px;padding:11px 14px;outline:none;transition:border-color .2s}
.auth-input:focus{border-color:var(--accent)}
.auth-input::placeholder{color:var(--muted)}
.auth-btn{width:100%;padding:13px;border-radius:8px;border:none;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;font-family:'Rajdhani';font-size:16px;font-weight:700;letter-spacing:1.5px;cursor:pointer;transition:filter .15s;margin-top:8px}
.auth-btn:hover{filter:brightness(1.12)}
.auth-btn:disabled{opacity:.5;cursor:not-allowed}
.auth-error{background:rgba(244,67,54,.12);border:1px solid rgba(244,67,54,.3);border-radius:6px;padding:10px 14px;font-size:12px;color:var(--error);font-family:'Inter';margin-bottom:14px;display:none}
.auth-error.visible{display:block}
.auth-divider{text-align:center;color:var(--muted);font-size:11px;letter-spacing:1px;margin:16px 0;position:relative}
.auth-divider::before{content:'';position:absolute;left:0;top:50%;width:40%;height:1px;background:var(--border)}
.auth-divider::after{content:'';position:absolute;right:0;top:50%;width:40%;height:1px;background:var(--border)}
.avatar-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-bottom:16px}
.avatar-opt{width:40px;height:40px;border-radius:50%;border:2px solid var(--border);cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;background:var(--surface);transition:all .15s}
.avatar-opt:hover,.avatar-opt.selected{border-color:var(--accent);background:rgba(255,60,0,.15)}

/* ‚îÄ‚îÄ Titlebar ‚îÄ‚îÄ */
#titlebar{height:38px;background:#060608;display:flex;align-items:center;justify-content:space-between;padding:0 16px;-webkit-app-region:drag;flex-shrink:0;border-bottom:1px solid var(--border);z-index:100}
.title-logo{font-family:'Bebas Neue';font-size:18px;letter-spacing:3px;background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.title-right{display:flex;align-items:center;gap:8px;-webkit-app-region:no-drag}
.title-btn{width:28px;height:28px;border-radius:4px;border:none;background:transparent;color:var(--muted);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;transition:all .15s}
.title-btn:hover{background:rgba(255,255,255,.08);color:var(--text)}
.title-btn.close:hover{background:#c0392b;color:#fff}
.title-user{display:flex;align-items:center;gap:8px;padding:4px 10px;border-radius:6px;cursor:pointer;transition:background .15s;-webkit-app-region:no-drag}
.title-user:hover{background:rgba(255,255,255,.06)}
.title-avatar{width:22px;height:22px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:12px}
.title-username{font-size:13px;font-weight:600;color:var(--text)}
.online-dot{width:6px;height:6px;border-radius:50%;background:var(--success);box-shadow:0 0 5px var(--success)}

/* ‚îÄ‚îÄ Update banner ‚îÄ‚îÄ */
#update-banner{display:none;background:linear-gradient(90deg,#1a2a1a,#0f1f0f);border-bottom:1px solid rgba(0,230,118,.3);padding:7px 20px;align-items:center;gap:12px;flex-shrink:0}
#update-banner.visible{display:flex}
.update-dot{width:7px;height:7px;border-radius:50%;background:var(--success);box-shadow:0 0 8px var(--success);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.update-text{flex:1;font-size:13px;font-weight:600;color:var(--success)}
.btn-update{padding:4px 14px;border-radius:5px;border:1px solid var(--success);background:transparent;color:var(--success);cursor:pointer;font-family:'Rajdhani';font-size:13px;font-weight:700;transition:all .15s}
.btn-update:hover{background:var(--success);color:#000}
.btn-dismiss{background:none;border:none;color:var(--muted);cursor:pointer;font-size:16px;padding:2px 6px}

/* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
#app{display:flex;flex:1;overflow:hidden}

/* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
#sidebar{width:var(--sidebar-w);background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;overflow:hidden}
.sidebar-top{padding:16px 12px 8px;flex-shrink:0}
.sidebar-label{font-size:10px;letter-spacing:2px;color:var(--muted);text-transform:uppercase;padding:5px 8px;margin-bottom:3px}
.nav-item{display:flex;align-items:center;gap:9px;padding:9px 12px;border-radius:6px;cursor:pointer;font-size:14px;font-weight:600;color:var(--muted);transition:all .15s;border:none;background:none;width:100%;text-align:left}
.nav-item:hover{background:rgba(255,255,255,.06);color:var(--text)}
.nav-item.active{background:rgba(255,60,0,.15);color:var(--accent2);border-left:2px solid var(--accent)}
.nav-item svg{flex-shrink:0;width:14px;height:14px}
.sidebar-divider{height:1px;background:var(--border);margin:8px 16px}
.sidebar-scroll{flex:1;overflow-y:auto;padding:0 12px;scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.05) transparent}
#queue-panel{border-top:1px solid var(--border);padding:10px 12px;flex-shrink:0;max-height:200px;overflow-y:auto}
.queue-title{font-size:10px;letter-spacing:2px;color:var(--muted);text-transform:uppercase;margin-bottom:6px;display:flex;align-items:center;justify-content:space-between}
.queue-count{background:var(--accent);color:#fff;font-size:9px;padding:1px 5px;border-radius:3px;display:none}
.queue-count.visible{display:block}
.queue-empty{font-size:11px;color:var(--muted);font-family:'Inter';text-align:center;padding:6px 0;opacity:.5}
.queue-item{background:var(--card);border-radius:5px;padding:7px 9px;margin-bottom:5px;border:1px solid var(--border)}
.queue-item-name{font-size:11px;font-weight:700;margin-bottom:3px;display:flex;align-items:center;justify-content:space-between;gap:4px}
.q-name-text{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1}
.queue-status-badge{font-size:8px;letter-spacing:1px;padding:2px 4px;border-radius:3px;text-transform:uppercase;flex-shrink:0}
.badge-waiting{background:rgba(255,215,64,.15);color:var(--warning)}
.badge-installing{background:rgba(255,60,0,.15);color:var(--accent2)}
.badge-done{background:rgba(0,230,118,.15);color:var(--success)}
.badge-error{background:rgba(244,67,54,.15);color:var(--error)}
.mini-progress{height:2px;background:rgba(255,255,255,.08);border-radius:2px;overflow:hidden;margin-top:3px}
.mini-fill{height:100%;border-radius:2px;transition:width .3s;background:linear-gradient(90deg,var(--accent),var(--accent2))}
.mini-fill.done{background:var(--success)}
.mini-fill.error{background:var(--error)}
.q-cancel{background:none;border:none;color:var(--muted);cursor:pointer;font-size:10px;line-height:1;flex-shrink:0}
.q-cancel:hover{color:var(--error)}

/* ‚îÄ‚îÄ Main area ‚îÄ‚îÄ */
#main{flex:1;overflow:hidden;display:flex;flex-direction:column}
#topbar{background:var(--surface);border-bottom:1px solid var(--border);padding:12px 24px;display:flex;align-items:center;gap:14px;flex-shrink:0;flex-wrap:wrap}
#page-title{font-family:'Bebas Neue';font-size:24px;letter-spacing:2px;color:var(--text);flex-shrink:0}
.search-wrap{flex:1;max-width:340px;position:relative}
.search-icon{position:absolute;left:11px;top:50%;transform:translateY(-50%);color:var(--muted)}
#search{width:100%;background:var(--card);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:'Rajdhani';font-size:14px;padding:8px 12px 8px 34px;outline:none;transition:border-color .2s}
#search:focus{border-color:var(--accent)}
#search::placeholder{color:var(--muted)}
.category-tabs{display:flex;gap:5px;flex-wrap:wrap}
.cat-tab{padding:5px 12px;border-radius:18px;border:1px solid var(--border);background:transparent;color:var(--muted);font-family:'Rajdhani';font-size:12px;font-weight:600;cursor:pointer;transition:all .15s}
.cat-tab:hover{border-color:var(--accent);color:var(--text)}
.cat-tab.active{background:var(--accent);border-color:var(--accent);color:#fff}

/* ‚îÄ‚îÄ Pages ‚îÄ‚îÄ */
.page{display:none;flex:1;overflow:hidden;flex-direction:column}
.page.active{display:flex}

/* ‚îÄ‚îÄ Store grid ‚îÄ‚îÄ */
#content{flex:1;overflow-y:auto;padding:20px 24px;scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.1) transparent}
#content::-webkit-scrollbar{width:4px}
#content::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:2px}
.store-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}

/* ‚îÄ‚îÄ App Card ‚îÄ‚îÄ */
.app-card{background:var(--card);border:1px solid var(--border);border-radius:10px;overflow:hidden;transition:transform .18s,border-color .18s,box-shadow .18s;animation:fadeIn .3s ease both}
.app-card:hover{transform:translateY(-3px);border-color:rgba(255,60,0,.35);box-shadow:0 8px 28px rgba(255,60,0,.1)}
.app-card.installed{border-color:rgba(0,230,118,.18)}
.app-card.installed:hover{border-color:rgba(0,230,118,.45);box-shadow:0 8px 24px rgba(0,230,118,.07)}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.card-img{width:100%;height:120px;background:linear-gradient(135deg,#1a1a24,#0e0e18);display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative;cursor:pointer}
.card-img img{max-height:68px;max-width:75%;object-fit:contain;filter:drop-shadow(0 4px 12px rgba(0,0,0,.5));transition:transform .2s}
.app-card:hover .card-img img{transform:scale(1.06)}
.card-cat-badge{position:absolute;top:7px;right:7px;background:rgba(0,0,0,.75);border:1px solid var(--border);border-radius:3px;font-size:8px;letter-spacing:1px;color:var(--muted);padding:2px 5px;text-transform:uppercase}
.installed-badge{position:absolute;top:7px;left:7px;background:rgba(0,230,118,.15);border:1px solid rgba(0,230,118,.4);border-radius:3px;font-size:8px;letter-spacing:1px;color:var(--success);padding:2px 5px;text-transform:uppercase;display:none}
.app-card.installed .installed-badge{display:block}
.card-body{padding:11px 13px}
.card-name{font-size:15px;font-weight:700;letter-spacing:.5px;margin-bottom:2px;color:var(--text)}
.card-desc{font-size:11px;color:var(--muted);line-height:1.5;font-family:'Inter';font-weight:300;margin-bottom:8px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.card-rating{display:flex;align-items:center;gap:5px;margin-bottom:8px}
.stars{color:var(--warning);font-size:12px;letter-spacing:1px}
.rating-count{font-size:10px;color:var(--muted);font-family:'Inter'}
.card-progress{margin-bottom:8px;display:none}
.card-progress.visible{display:block}
.progress-bar{height:3px;background:rgba(255,255,255,.08);border-radius:2px;overflow:hidden;margin-bottom:3px}
.progress-fill{height:100%;border-radius:2px;transition:width .4s ease;background:linear-gradient(90deg,var(--accent),var(--accent2))}
.progress-fill.done{background:var(--success)}
.progress-fill.err{background:var(--error)}
.progress-text{font-size:9px;color:var(--muted);font-family:'Inter';display:flex;justify-content:space-between}
.card-footer{display:flex;gap:6px}
.btn{padding:7px 10px;border-radius:5px;border:none;cursor:pointer;font-family:'Rajdhani';font-size:12px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:4px;flex:1}
.btn:disabled{opacity:.45;cursor:not-allowed}
.btn-install{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff}
.btn-install:hover:not(:disabled){filter:brightness(1.15)}
.btn-launch{background:rgba(0,230,118,.1);border:1px solid rgba(0,230,118,.35);color:var(--success)}
.btn-launch:hover:not(:disabled){background:rgba(0,230,118,.2)}
.btn-cancel{background:rgba(244,67,54,.1);border:1px solid rgba(244,67,54,.3);color:var(--error)}
.btn-cancel:hover{background:rgba(244,67,54,.2)}
.btn-uninstall{background:transparent;border:1px solid rgba(255,255,255,.1);color:var(--muted)}
.btn-uninstall:hover{background:rgba(244,67,54,.1);border-color:rgba(244,67,54,.3);color:var(--error)}
.btn-sm{flex:0;padding:7px 9px;background:transparent;border:1px solid var(--border);color:var(--muted)}
.btn-sm:hover{background:rgba(255,255,255,.06);color:var(--text)}

/* ‚îÄ‚îÄ Community Panel ‚îÄ‚îÄ */
#community-panel{width:var(--community-w);background:var(--surface);border-left:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;overflow:hidden}
.comm-header{padding:14px 16px;border-bottom:1px solid var(--border);flex-shrink:0}
.comm-title{font-family:'Bebas Neue';font-size:18px;letter-spacing:2px;color:var(--text);margin-bottom:12px}
.my-profile-card{background:var(--card);border-radius:8px;padding:12px;border:1px solid var(--border)}
.profile-top{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.profile-avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;border:2px solid rgba(255,60,0,.3)}
.profile-info{flex:1;min-width:0}
.profile-name{font-size:15px;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.profile-status{font-size:11px;color:var(--muted);font-family:'Inter';display:flex;align-items:center;gap:5px}
.status-indicator{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.status-online{background:var(--success);box-shadow:0 0 5px var(--success)}
.status-offline{background:var(--muted)}
.status-playing{background:var(--info);box-shadow:0 0 5px var(--info);animation:pulse 2s infinite}
.profile-stats{display:flex;gap:8px}
.profile-stat{flex:1;background:var(--surface);border-radius:5px;padding:6px 8px;text-align:center}
.stat-val{font-size:16px;font-weight:700;color:var(--accent2)}
.stat-lab{font-size:9px;color:var(--muted);letter-spacing:1px;text-transform:uppercase}
.comm-search{position:relative;padding:10px 12px;flex-shrink:0}
.comm-search input{width:100%;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'Rajdhani';font-size:13px;padding:7px 10px 7px 30px;outline:none;transition:border-color .2s}
.comm-search input:focus{border-color:var(--accent)}
.comm-search input::placeholder{color:var(--muted)}
.comm-search-icon{position:absolute;left:20px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:12px}
.comm-scroll{flex:1;overflow-y:auto;padding:0 12px 12px;scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.05) transparent}
.comm-section{margin-bottom:14px}
.comm-section-title{font-size:10px;letter-spacing:2px;color:var(--muted);text-transform:uppercase;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between}
.comm-section-count{background:rgba(255,255,255,.07);border-radius:3px;padding:1px 6px;font-size:9px}
.friend-card{background:var(--card);border:1px solid var(--border);border-radius:7px;padding:9px 10px;margin-bottom:6px;display:flex;align-items:center;gap:9px;cursor:pointer;transition:all .15s}
.friend-card:hover{border-color:rgba(255,60,0,.3);background:var(--card2)}
.friend-avatar{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,#333,#555);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;position:relative}
.friend-status-dot{position:absolute;bottom:0;right:0;width:9px;height:9px;border-radius:50%;border:2px solid var(--card)}
.friend-info{flex:1;min-width:0}
.friend-name{font-size:13px;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.friend-activity{font-size:10px;color:var(--muted);font-family:'Inter';overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.friend-actions{display:flex;gap:4px;flex-shrink:0}
.friend-btn{width:26px;height:26px;border-radius:4px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;font-size:11px;display:flex;align-items:center;justify-content:center;transition:all .15s}
.friend-btn:hover{background:rgba(255,255,255,.08);color:var(--text)}
.friend-btn.accept{border-color:rgba(0,230,118,.4);color:var(--success)}
.friend-btn.accept:hover{background:rgba(0,230,118,.15)}
.friend-btn.reject{border-color:rgba(244,67,54,.4);color:var(--error)}
.friend-btn.reject:hover{background:rgba(244,67,54,.15)}
.find-user-result{background:var(--card);border:1px solid var(--border);border-radius:7px;padding:9px 10px;margin-bottom:6px;display:flex;align-items:center;gap:9px}
.add-friend-btn{padding:4px 10px;border-radius:4px;border:1px solid rgba(255,60,0,.4);background:transparent;color:var(--accent2);cursor:pointer;font-family:'Rajdhani';font-size:11px;font-weight:700;transition:all .15s;margin-left:auto;flex-shrink:0}
.add-friend-btn:hover{background:rgba(255,60,0,.15)}

/* ‚îÄ‚îÄ Rating stars interactive ‚îÄ‚îÄ */
.star-rating{display:flex;gap:3px;margin-bottom:10px}
.star-rating span{font-size:22px;cursor:pointer;color:rgba(255,255,255,.2);transition:color .1s}
.star-rating span.active,.star-rating span:hover{color:var(--warning)}

/* ‚îÄ‚îÄ Profile modal ‚îÄ‚îÄ */
#profile-modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:3000;align-items:center;justify-content:center;backdrop-filter:blur(6px)}
#profile-modal-overlay.open{display:flex}
#profile-modal{background:var(--card);border:1px solid rgba(255,255,255,.1);border-radius:14px;width:480px;max-width:92vw;overflow:hidden;animation:modalIn .2s ease}
@keyframes modalIn{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}
.pm-banner{height:100px;background:linear-gradient(135deg,rgba(255,60,0,.3),rgba(255,122,60,.1));position:relative;display:flex;align-items:flex-end;padding:0 20px 0}
.pm-avatar{width:64px;height:64px;border-radius:50%;border:3px solid var(--card);display:flex;align-items:center;justify-content:center;font-size:30px;background:linear-gradient(135deg,var(--accent),var(--accent2));transform:translateY(32px)}
.pm-body{padding:40px 20px 20px}
.pm-name{font-family:'Bebas Neue';font-size:24px;letter-spacing:1px;margin-bottom:2px}
.pm-status{font-size:12px;color:var(--muted);font-family:'Inter';margin-bottom:14px;display:flex;align-items:center;gap:6px}
.pm-stats{display:flex;gap:10px;margin-bottom:16px}
.pm-stat{flex:1;background:var(--surface);border-radius:6px;padding:10px;text-align:center}
.pm-stat-val{font-size:20px;font-weight:700;color:var(--accent2)}
.pm-stat-lab{font-size:9px;color:var(--muted);letter-spacing:1px;text-transform:uppercase}
.pm-apps-title{font-size:11px;letter-spacing:1.5px;color:var(--muted);text-transform:uppercase;margin-bottom:8px}
.pm-apps-grid{display:flex;flex-wrap:wrap;gap:6px;max-height:100px;overflow-y:auto}
.pm-app-badge{background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:4px 8px;font-size:11px;font-weight:600;display:flex;align-items:center;gap:5px}
.pm-app-badge img{width:14px;height:14px;object-fit:contain}
.pm-actions{display:flex;gap:8px;margin-top:14px}
.pm-close{position:absolute;top:10px;right:14px;background:none;border:none;color:rgba(255,255,255,.5);cursor:pointer;font-size:18px}
.pm-close:hover{color:#fff}

/* ‚îÄ‚îÄ Modal app detail ‚îÄ‚îÄ */
#modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.82);z-index:2000;align-items:center;justify-content:center;backdrop-filter:blur(6px)}
#modal-overlay.open{display:flex}
#modal{background:var(--card);border:1px solid rgba(255,255,255,.1);border-radius:14px;width:500px;max-width:92vw;overflow:hidden;animation:modalIn .2s ease}
.modal-header{padding:18px 20px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.modal-title{font-family:'Bebas Neue';font-size:20px;letter-spacing:1.5px}
.modal-installed-chip{font-size:9px;letter-spacing:1px;padding:3px 7px;border-radius:4px;background:rgba(0,230,118,.15);color:var(--success);border:1px solid rgba(0,230,118,.3);margin-left:8px;display:none}
.modal-installed-chip.visible{display:inline-block}
.modal-close{background:none;border:none;color:var(--muted);cursor:pointer;font-size:18px}
.modal-close:hover{color:var(--text)}
.modal-body{padding:16px 20px}
.modal-img-wrap{background:linear-gradient(135deg,#1a1a24,#0e0e18);border-radius:7px;height:100px;display:flex;align-items:center;justify-content:center;margin-bottom:12px}
.modal-img-wrap img{max-height:60px;max-width:75%;object-fit:contain}
.modal-desc{font-family:'Inter';font-size:12px;color:var(--muted);line-height:1.6;margin-bottom:12px}
.modal-row{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
.modal-info{flex:1;min-width:80px;background:var(--surface);border-radius:5px;padding:8px 10px}
.modal-info-label{font-size:8px;letter-spacing:1.5px;color:var(--muted);text-transform:uppercase;margin-bottom:2px}
.modal-info-val{font-size:13px;font-weight:700}
.modal-rating-section{background:var(--surface);border-radius:7px;padding:12px;margin-bottom:12px}
.modal-rating-title{font-size:10px;letter-spacing:1.5px;color:var(--muted);text-transform:uppercase;margin-bottom:8px}
.modal-rating-avg{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.modal-rating-big{font-size:28px;font-weight:700;color:var(--warning)}
.modal-rating-stars{font-size:14px;color:var(--warning)}
.modal-rating-count{font-size:11px;color:var(--muted);font-family:'Inter'}
.modal-tags{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:12px}
.tag{background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:3px;font-size:9px;padding:2px 7px;color:var(--muted)}
.modal-actions{display:flex;gap:7px;flex-wrap:wrap}

/* ‚îÄ‚îÄ Confirm dialog ‚îÄ‚îÄ */
#confirm-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:4000;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
#confirm-overlay.open{display:flex}
#confirm-box{background:var(--card);border:1px solid rgba(244,67,54,.3);border-radius:12px;width:360px;max-width:90vw;padding:22px;animation:modalIn .15s ease;text-align:center}
.confirm-icon{font-size:30px;margin-bottom:10px}
.confirm-title{font-family:'Bebas Neue';font-size:18px;letter-spacing:1px;margin-bottom:6px}
.confirm-msg{font-size:12px;color:var(--muted);font-family:'Inter';line-height:1.5;margin-bottom:18px}
.confirm-actions{display:flex;gap:8px;justify-content:center}
.btn-confirm-yes{padding:9px 22px;border-radius:5px;border:none;background:var(--error);color:#fff;cursor:pointer;font-family:'Rajdhani';font-size:14px;font-weight:700;letter-spacing:1px;transition:filter .15s}
.btn-confirm-yes:hover{filter:brightness(1.15)}
.btn-confirm-no{padding:9px 22px;border-radius:5px;border:1px solid var(--border);background:transparent;color:var(--text);cursor:pointer;font-family:'Rajdhani';font-size:14px;font-weight:700;letter-spacing:1px}
.btn-confirm-no:hover{background:rgba(255,255,255,.06)}

/* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
#toast-container{position:fixed;bottom:28px;right:24px;display:flex;flex-direction:column;gap:7px;z-index:9999;pointer-events:none}
.toast{background:var(--card2);border:1px solid var(--border);border-radius:7px;padding:11px 14px;min-width:250px;max-width:320px;display:flex;align-items:flex-start;gap:9px;animation:toastIn .25s ease;border-left:3px solid var(--accent);pointer-events:all}
.toast.success{border-left-color:var(--success)}
.toast.error{border-left-color:var(--error)}
.toast.info{border-left-color:var(--info)}
.toast.warning{border-left-color:var(--warning)}
@keyframes toastIn{from{opacity:0;transform:translateX(30px)}to{opacity:1;transform:translateX(0)}}
.toast-icon{font-size:16px;line-height:1.3}
.toast-content{flex:1}
.toast-title{font-weight:700;font-size:12px;margin-bottom:2px}
.toast-msg{font-size:10px;color:var(--muted);font-family:'Inter';line-height:1.4}

/* ‚îÄ‚îÄ Statusbar ‚îÄ‚îÄ */
#statusbar{height:24px;background:#060608;border-top:1px solid var(--border);display:flex;align-items:center;padding:0 16px;gap:16px;flex-shrink:0}
.status-item{font-size:10px;color:var(--muted);display:flex;align-items:center;gap:4px}
.status-dot{width:5px;height:5px;border-radius:50%;background:var(--success);box-shadow:0 0 4px var(--success)}
.spin-small{width:9px;height:9px;border:1.5px solid rgba(255,255,255,.1);border-top-color:var(--accent2);border-radius:50%;animation:spin .6s linear infinite;display:none}
.spin-small.visible{display:block}
@keyframes spin{to{transform:rotate(360deg)}}

/* ‚îÄ‚îÄ Empty / loading ‚îÄ‚îÄ */
.empty-state{text-align:center;padding:50px 20px;color:var(--muted);grid-column:1/-1}
.empty-state h3{font-family:'Bebas Neue';font-size:24px;letter-spacing:2px;margin-bottom:6px;color:var(--text)}
.comm-empty{text-align:center;padding:20px 0;color:var(--muted);font-size:12px;font-family:'Inter'}
</style>
</head>
<body>

<!-- ‚ïê‚ïê AUTH OVERLAY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="auth-overlay">
  <div class="auth-box">
    <div class="auth-header">
      <div class="auth-logo">FIRYXIS LAUNCHER</div>
      <div class="auth-subtitle">Rejoignez la communaut√© Firyxis</div>
    </div>
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchAuthTab('login')">Connexion</button>
      <button class="auth-tab" onclick="switchAuthTab('register')">Inscription</button>
    </div>
    <div class="auth-body">
      <div class="auth-error" id="auth-error"></div>

      <!-- LOGIN -->
      <div id="tab-login">
        <div class="auth-field">
          <label class="auth-label">Email</label>
          <input class="auth-input" type="email" id="login-email" placeholder="votre@email.com"/>
        </div>
        <div class="auth-field">
          <label class="auth-label">Mot de passe</label>
          <input class="auth-input" type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
        </div>
        <button class="auth-btn" onclick="doLogin()">Se connecter</button>
      </div>

      <!-- REGISTER -->
      <div id="tab-register" style="display:none">
        <div class="auth-field">
          <label class="auth-label">Pseudo</label>
          <input class="auth-input" type="text" id="reg-pseudo" placeholder="MonPseudo" maxlength="20"/>
        </div>
        <div class="auth-field">
          <label class="auth-label">Avatar</label>
          <div class="avatar-grid" id="avatar-grid"></div>
        </div>
        <div class="auth-field">
          <label class="auth-label">Email</label>
          <input class="auth-input" type="email" id="reg-email" placeholder="votre@email.com"/>
        </div>
        <div class="auth-field">
          <label class="auth-label">Mot de passe</label>
          <input class="auth-input" type="password" id="reg-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6"/>
        </div>
        <button class="auth-btn" onclick="doRegister()">Cr√©er mon compte</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê TITLEBAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="titlebar">
  <span class="title-logo">FIRYXIS</span>
  <div class="title-right">
    <div class="title-user" id="title-user-btn" onclick="openMyProfile()">
      <div class="title-avatar" id="title-avatar">?</div>
      <span class="title-username" id="title-username">‚Äî</span>
      <div class="online-dot"></div>
    </div>
    <button class="title-btn" onclick="window.launcher.minimize()">&#x2212;</button>
    <button class="title-btn" onclick="window.launcher.maximize()">&#x25A1;</button>
    <button class="title-btn close" onclick="window.launcher.close()">&#x2715;</button>
  </div>
</div>

<!-- Update banner -->
<div id="update-banner">
  <div class="update-dot"></div>
  <div class="update-text">Mise √† jour disponible : <strong id="update-new-ver"></strong></div>
  <button class="btn-update" id="btn-do-update">T√©l√©charger</button>
  <button class="btn-dismiss" onclick="document.getElementById('update-banner').classList.remove('visible')">&#x2715;</button>
</div>

<!-- ‚ïê‚ïê APP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="app">

  <!-- SIDEBAR -->
  <aside id="sidebar">
    <div class="sidebar-top">
      <div class="sidebar-label">Navigation</div>
      <button class="nav-item active" onclick="setPage('store',this)">
        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
        Magasin
      </button>
      <button class="nav-item" onclick="setPage('community',this)">
        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        Communaut√©
      </button>
      <button class="nav-item" onclick="checkUpdateManual()">
        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
        V√©rifier MAJ
      </button>
      <button class="nav-item" onclick="rescanAllApps()">
        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        Scanner apps
      </button>
      <button class="nav-item" onclick="doLogout()">
        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        D√©connexion
      </button>
    </div>
    <div class="sidebar-divider"></div>
    <div class="sidebar-scroll">
      <div class="sidebar-label">Cat√©gories</div>
      <div id="sidebar-cats"></div>
    </div>
    <div id="queue-panel">
      <div class="queue-title">File d'attente <span class="queue-count" id="queue-count">0</span></div>
      <div id="queue-list"><div class="queue-empty">Aucune installation</div></div>
    </div>
  </aside>

  <!-- MAIN -->
  <div id="main">

    <!-- STORE PAGE -->
    <div class="page active" id="page-store">
      <div id="topbar">
        <span id="page-title">MAGASIN</span>
        <div class="search-wrap">
          <svg class="search-icon" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          <input id="search" type="text" placeholder="Rechercher..." oninput="filterApps()"/>
        </div>
        <div class="category-tabs" id="cat-tabs"></div>
      </div>
      <div id="content"><div class="store-grid" id="grid"></div></div>
    </div>

    <!-- COMMUNITY PAGE -->
    <div class="page" id="page-community">
      <div id="topbar" style="padding:12px 24px">
        <span style="font-family:'Bebas Neue';font-size:24px;letter-spacing:2px">COMMUNAUT√â</span>
      </div>
      <div style="flex:1;overflow-y:auto;padding:20px 24px;display:flex;gap:16px;flex-wrap:wrap;align-content:flex-start">

        <!-- Mon profil complet -->
        <div style="width:100%;background:var(--card);border:1px solid var(--border);border-radius:10px;overflow:hidden">
          <div style="height:80px;background:linear-gradient(135deg,rgba(255,60,0,.3),rgba(255,122,60,.1));position:relative">
            <div style="position:absolute;bottom:-24px;left:20px;width:52px;height:52px;border-radius:50%;border:3px solid var(--card);background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:24px" id="comm-my-avatar">üë§</div>
          </div>
          <div style="padding:32px 20px 16px;display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:12px">
            <div>
              <div style="font-family:'Bebas Neue';font-size:22px;letter-spacing:1px" id="comm-my-name">‚Äî</div>
              <div style="font-size:12px;color:var(--muted);font-family:'Inter'" id="comm-my-email">‚Äî</div>
            </div>
            <div style="display:flex;gap:16px">
              <div style="text-align:center"><div style="font-size:20px;font-weight:700;color:var(--accent2)" id="my-friends-count">0</div><div style="font-size:9px;color:var(--muted);letter-spacing:1px;text-transform:uppercase">Amis</div></div>
              <div style="text-align:center"><div style="font-size:20px;font-weight:700;color:var(--accent2)" id="my-apps-count">0</div><div style="font-size:9px;color:var(--muted);letter-spacing:1px;text-transform:uppercase">Apps</div></div>
              <div style="text-align:center"><div style="font-size:20px;font-weight:700;color:var(--accent2)" id="my-ratings-count">0</div><div style="font-size:9px;color:var(--muted);letter-spacing:1px;text-transform:uppercase">Avis</div></div>
            </div>
          </div>
        </div>

        <!-- Trouver des utilisateurs -->
        <div style="flex:1;min-width:280px;background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px">
          <div style="font-size:11px;letter-spacing:2px;color:var(--muted);text-transform:uppercase;margin-bottom:12px">Trouver des joueurs</div>
          <div style="display:flex;gap:8px;margin-bottom:12px">
            <input id="find-user-input" type="text" placeholder="Rechercher un pseudo..." style="flex:1;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'Rajdhani';font-size:13px;padding:8px 10px;outline:none" oninput="searchUsers(this.value)"/>
          </div>
          <div id="find-user-results"><div class="comm-empty">Tapez un pseudo pour chercher</div></div>
        </div>

        <!-- Demandes re√ßues -->
        <div style="flex:1;min-width:280px;background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px">
          <div style="font-size:11px;letter-spacing:2px;color:var(--muted);text-transform:uppercase;margin-bottom:12px">Demandes d'amis <span id="requests-count" style="background:var(--accent);color:#fff;font-size:9px;padding:1px 5px;border-radius:3px;display:none">0</span></div>
          <div id="friend-requests-list"><div class="comm-empty">Aucune demande en attente</div></div>
        </div>

        <!-- Liste amis compl√®te -->
        <div style="width:100%;background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px">
          <div style="font-size:11px;letter-spacing:2px;color:var(--muted);text-transform:uppercase;margin-bottom:12px">Mes amis</div>
          <div id="friends-list-full" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:8px">
            <div class="comm-empty" style="grid-column:1/-1">Aucun ami pour l'instant</div>
          </div>
        </div>

      </div>
    </div>

  </div>

  <!-- COMMUNITY PANEL (droite) -->
  <div id="community-panel">
    <div class="comm-header">
      <div class="comm-title">Amis</div>
      <div class="my-profile-card">
        <div class="profile-top">
          <div class="profile-avatar" id="cp-avatar">üë§</div>
          <div class="profile-info">
            <div class="profile-name" id="cp-name">‚Äî</div>
            <div class="profile-status">
              <div class="status-indicator status-online"></div>
              <span id="cp-status">En ligne</span>
            </div>
          </div>
        </div>
        <div class="profile-stats">
          <div class="profile-stat"><div class="stat-val" id="cp-friends">0</div><div class="stat-lab">Amis</div></div>
          <div class="profile-stat"><div class="stat-val" id="cp-apps">0</div><div class="stat-lab">Apps</div></div>
        </div>
      </div>
    </div>
    <div class="comm-search">
      <span class="comm-search-icon">üîç</span>
      <input type="text" placeholder="Chercher un ami..." oninput="filterFriendsList(this.value)"/>
    </div>
    <div class="comm-scroll">
      <!-- Amis en ligne -->
      <div class="comm-section">
        <div class="comm-section-title">En ligne <span class="comm-section-count" id="online-count">0</span></div>
        <div id="friends-online"></div>
      </div>
      <!-- Amis hors ligne -->
      <div class="comm-section">
        <div class="comm-section-title">Hors ligne <span class="comm-section-count" id="offline-count">0</span></div>
        <div id="friends-offline"></div>
      </div>
    </div>
  </div>

</div>

<!-- Statusbar -->
<div id="statusbar">
  <div class="status-item"><div class="status-dot"></div> En ligne</div>
  <div class="status-item" id="app-count">‚Äî</div>
  <div class="status-item" id="installed-count" style="color:var(--success)"></div>
  <div class="status-item" style="margin-left:auto">
    <div class="spin-small" id="scan-spin"></div>
    <span id="scan-label"></span>
  </div>
</div>

<!-- ‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- App detail modal -->
<div id="modal-overlay" onclick="closeModal(event)">
  <div id="modal">
    <div class="modal-header">
      <div style="display:flex;align-items:center">
        <span class="modal-title" id="modal-title"></span>
        <span class="modal-installed-chip" id="modal-installed-chip">‚úì INSTALL√â</span>
      </div>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="modal-img-wrap"><img id="modal-img" src="" alt=""/></div>
      <p class="modal-desc" id="modal-desc"></p>
      <div class="modal-row" id="modal-row"></div>
      <div class="modal-rating-section">
        <div class="modal-rating-title">√âvaluations</div>
        <div class="modal-rating-avg">
          <div class="modal-rating-big" id="modal-avg">‚Äî</div>
          <div>
            <div class="modal-rating-stars" id="modal-stars">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</div>
            <div class="modal-rating-count" id="modal-count">0 avis</div>
          </div>
        </div>
        <div style="font-size:10px;color:var(--muted);margin-bottom:6px;font-family:'Inter'">Votre note :</div>
        <div class="star-rating" id="modal-user-stars">
          <span onclick="rateApp(1)">‚òÖ</span><span onclick="rateApp(2)">‚òÖ</span>
          <span onclick="rateApp(3)">‚òÖ</span><span onclick="rateApp(4)">‚òÖ</span><span onclick="rateApp(5)">‚òÖ</span>
        </div>
      </div>
      <div class="modal-tags" id="modal-tags"></div>
      <div class="modal-actions" id="modal-actions"></div>
    </div>
  </div>
</div>

<!-- Profile modal -->
<div id="profile-modal-overlay" onclick="closeProfileModal(event)">
  <div id="profile-modal" style="position:relative">
    <button class="pm-close" onclick="closeProfileModal()">‚úï</button>
    <div class="pm-banner">
      <div class="pm-avatar" id="pm-avatar">üë§</div>
    </div>
    <div class="pm-body">
      <div class="pm-name" id="pm-name">‚Äî</div>
      <div class="pm-status" id="pm-status"><div class="status-indicator status-offline" id="pm-dot"></div><span id="pm-status-text">Hors ligne</span></div>
      <div class="pm-stats">
        <div class="pm-stat"><div class="pm-stat-val" id="pm-apps-count">0</div><div class="pm-stat-lab">Apps</div></div>
        <div class="pm-stat"><div class="pm-stat-val" id="pm-friends-count">0</div><div class="pm-stat-lab">Amis</div></div>
        <div class="pm-stat"><div class="pm-stat-val" id="pm-rating-count">0</div><div class="pm-stat-lab">Avis</div></div>
      </div>
      <div class="pm-apps-title">Applications install√©es</div>
      <div class="pm-apps-grid" id="pm-apps-grid"></div>
      <div class="pm-actions" id="pm-actions"></div>
    </div>
  </div>
</div>

<!-- Confirm dialog -->
<div id="confirm-overlay">
  <div id="confirm-box">
    <div class="confirm-icon">üóë</div>
    <div class="confirm-title" id="confirm-title"></div>
    <p class="confirm-msg" id="confirm-msg"></p>
    <div class="confirm-actions">
      <button class="btn-confirm-no" onclick="closeConfirm()">Annuler</button>
      <button class="btn-confirm-yes" id="confirm-yes-btn">Confirmer</button>
    </div>
  </div>
</div>

<div id="toast-container"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let db, auth, rtdb, currentUser, currentUserData;

function initFirebase() {
  try {
    if (!window.FIREBASE_CONFIG || window.FIREBASE_CONFIG.apiKey === 'VOTRE_API_KEY') {
      showConfigError();
      return false;
    }
    firebase.initializeApp(window.FIREBASE_CONFIG);
    auth  = firebase.auth();
    db    = firebase.firestore();
    rtdb  = firebase.database();
    return true;
  } catch(e) {
    showConfigError();
    return false;
  }
}

function showConfigError() {
  const overlay = document.getElementById('auth-overlay');
  overlay.innerHTML = `
    <div class="auth-box">
      <div class="auth-header">
        <div class="auth-logo">FIRYXIS LAUNCHER</div>
      </div>
      <div class="auth-body">
        <div class="auth-error visible" style="display:block">
          ‚ö† Firebase n'est pas configur√© !<br><br>
          Ouvre le fichier <strong>src/renderer/firebase-config.js</strong>
          et remplis tes identifiants Firebase.<br><br>
          <a onclick="window.launcher.openUrl('https://console.firebase.google.com')" 
             style="color:var(--accent2);cursor:pointer;text-decoration:underline">
            ‚Üí Cr√©er un projet Firebase
          </a>
        </div>
      </div>
    </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AVATARS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const AVATARS = ['ü¶ä','üê∫','ü¶Å','üêØ','üêª','üêº','ü¶Ö','ü¶ã','üêâ','üéÆ','‚ö°','üî•','üíé','üåü','üöÄ','üëæ','üéØ','üíÄ','ü§ñ','üé≠','ü¶æ','üõ°'];
let selectedAvatar = AVATARS[0];

function buildAvatarGrid() {
  const grid = document.getElementById('avatar-grid');
  grid.innerHTML = AVATARS.map((a,i) =>
    `<div class="avatar-opt ${i===0?'selected':''}" onclick="selectAvatar('${a}',this)">${a}</div>`
  ).join('');
}

function selectAvatar(emoji, el) {
  document.querySelectorAll('.avatar-opt').forEach(e => e.classList.remove('selected'));
  el.classList.add('selected');
  selectedAvatar = emoji;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchAuthTab(tab) {
  document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('tab-login').style.display    = tab === 'login' ? '' : 'none';
  document.getElementById('tab-register').style.display = tab === 'register' ? '' : 'none';
  clearAuthError();
}

function showAuthError(msg) {
  const el = document.getElementById('auth-error');
  el.textContent = msg; el.classList.add('visible');
}
function clearAuthError() {
  document.getElementById('auth-error').classList.remove('visible');
}

async function doLogin() {
  clearAuthError();
  const email    = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value;
  if (!email || !password) return showAuthError('Remplis tous les champs.');
  try {
    await auth.signInWithEmailAndPassword(email, password);
  } catch(e) {
    const msgs = {
      'auth/user-not-found':   'Aucun compte avec cet email.',
      'auth/wrong-password':   'Mot de passe incorrect.',
      'auth/invalid-email':    'Email invalide.',
      'auth/too-many-requests':'Trop de tentatives. R√©essaie plus tard.',
    };
    showAuthError(msgs[e.code] || e.message);
  }
}

async function doRegister() {
  clearAuthError();
  const pseudo   = document.getElementById('reg-pseudo').value.trim();
  const email    = document.getElementById('reg-email').value.trim();
  const password = document.getElementById('reg-password').value;
  if (!pseudo || !email || !password) return showAuthError('Remplis tous les champs.');
  if (pseudo.length < 3) return showAuthError('Pseudo trop court (3 caract√®res min).');
  if (password.length < 6) return showAuthError('Mot de passe trop court (6 caract√®res min).');

  try {
    // V√©rifier unicit√© du pseudo
    const snap = await db.collection('users').where('pseudoLower','==',pseudo.toLowerCase()).get();
    if (!snap.empty) return showAuthError('Ce pseudo est d√©j√† pris.');

    const cred = await auth.createUserWithEmailAndPassword(email, password);
    const uid  = cred.user.uid;

    await db.collection('users').doc(uid).set({
      uid, pseudo, pseudoLower: pseudo.toLowerCase(),
      avatar: selectedAvatar, email,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      friends: [], installedApps: [], ratings: {},
      friendRequests: { sent: [], received: [] }
    });

    // Statut en ligne
    await setOnlineStatus(uid, 'online');
  } catch(e) {
    const msgs = {
      'auth/email-already-in-use': 'Cet email est d√©j√† utilis√©.',
      'auth/invalid-email':        'Email invalide.',
      'auth/weak-password':        'Mot de passe trop faible.',
    };
    showAuthError(msgs[e.code] || e.message);
  }
}

async function doLogout() {
  if (currentUser) {
    await setOnlineStatus(currentUser.uid, 'offline');
    await rtdb.ref(`presence/${currentUser.uid}`).remove();
  }
  await auth.signOut();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PRESENCE (statut en ligne)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function setOnlineStatus(uid, status, activity = '') {
  try {
    const ref = rtdb.ref(`presence/${uid}`);
    await ref.set({ status, activity, lastSeen: firebase.database.ServerValue.TIMESTAMP });
    if (status === 'online') {
      ref.onDisconnect().set({ status: 'offline', activity: '', lastSeen: firebase.database.ServerValue.TIMESTAMP });
    }
  } catch(e) {}
}

function listenPresence(uid, callback) {
  rtdb.ref(`presence/${uid}`).on('value', snap => {
    callback(snap.val() || { status: 'offline', activity: '' });
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AFTER LOGIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function onUserLoggedIn(user) {
  currentUser = user;
  document.getElementById('auth-overlay').classList.add('hidden');

  // Charger donn√©es utilisateur
  const snap = await db.collection('users').doc(user.uid).get();
  currentUserData = snap.data();

  if (!currentUserData) {
    await doLogout();
    return;
  }

  // Mettre √† jour UI
  updateUserUI();
  setOnlineStatus(user.uid, 'online');

  // Init launcher
  await initLauncher();

  // √âcouter amis
  listenFriends();
  listenFriendRequests();
}

function updateUserUI() {
  const { pseudo, avatar } = currentUserData;
  document.getElementById('title-avatar').textContent   = avatar || 'üë§';
  document.getElementById('title-username').textContent = pseudo;
  document.getElementById('cp-avatar').textContent      = avatar || 'üë§';
  document.getElementById('cp-name').textContent        = pseudo;
  document.getElementById('comm-my-avatar').textContent = avatar || 'üë§';
  document.getElementById('comm-my-name').textContent   = pseudo;
  document.getElementById('comm-my-email').textContent  = currentUser.email;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AMIS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let friendsData = [];
let friendsFilter = '';

function listenFriends() {
  db.collection('users').doc(currentUser.uid).onSnapshot(snap => {
    currentUserData = snap.data();
    const friends = currentUserData.friends || [];
    document.getElementById('cp-friends').textContent  = friends.length;
    document.getElementById('my-friends-count').textContent = friends.length;
    loadFriendsDetails(friends);
  });
}

async function loadFriendsDetails(friendUids) {
  if (!friendUids.length) {
    renderFriendsSidebar([]);
    renderFriendsGrid([]);
    return;
  }
  friendsData = [];
  for (const uid of friendUids) {
    const snap = await db.collection('users').doc(uid).get();
    if (snap.exists) friendsData.push({ uid, ...snap.data() });
  }
  // √âcouter presence
  friendsData.forEach(f => {
    listenPresence(f.uid, (presence) => {
      const idx = friendsData.findIndex(fd => fd.uid === f.uid);
      if (idx !== -1) friendsData[idx].presence = presence;
      renderFriendsSidebar(friendsData);
      renderFriendsGrid(friendsData);
    });
  });
  renderFriendsSidebar(friendsData);
  renderFriendsGrid(friendsData);
}

function filterFriendsList(q) {
  friendsFilter = q.toLowerCase();
  const filtered = friendsData.filter(f => f.pseudo.toLowerCase().includes(friendsFilter));
  renderFriendsSidebar(filtered);
}

function renderFriendsSidebar(friends) {
  const online  = friends.filter(f => f.presence?.status === 'online');
  const offline = friends.filter(f => f.presence?.status !== 'online');
  document.getElementById('online-count').textContent  = online.length;
  document.getElementById('offline-count').textContent = offline.length;
  document.getElementById('cp-friends').textContent    = friends.length;

  const renderList = (list) => list.map(f => {
    const status   = f.presence?.status || 'offline';
    const activity = f.presence?.activity || '';
    const dotCls   = status === 'online' ? 'status-online' : status === 'playing' ? 'status-playing' : 'status-offline';
    return `<div class="friend-card" onclick="openProfileModal('${f.uid}')">
      <div class="friend-avatar">${f.avatar||'üë§'}<div class="friend-status-dot ${dotCls}"></div></div>
      <div class="friend-info">
        <div class="friend-name">${f.pseudo}</div>
        <div class="friend-activity">${activity || (status === 'online' ? 'En ligne' : 'Hors ligne')}</div>
      </div>
      <div class="friend-actions">
        <button class="friend-btn" onclick="event.stopPropagation();removeFriend('${f.uid}','${f.pseudo}')" title="Retirer">‚úï</button>
      </div>
    </div>`;
  }).join('') || `<div class="comm-empty">Aucun ami ${friendsFilter ? 'trouv√©' : ''}</div>`;

  document.getElementById('friends-online').innerHTML  = renderList(online);
  document.getElementById('friends-offline').innerHTML = renderList(offline);
}

function renderFriendsGrid(friends) {
  const el = document.getElementById('friends-list-full');
  if (!friends.length) {
    el.innerHTML = `<div class="comm-empty" style="grid-column:1/-1">Aucun ami ‚Äî cherchez des joueurs dans "Trouver des joueurs" !</div>`;
    return;
  }
  el.innerHTML = friends.map(f => {
    const status = f.presence?.status || 'offline';
    const dotCls = status === 'online' ? 'status-online' : 'status-offline';
    const activity = f.presence?.activity || '';
    return `<div class="friend-card" onclick="openProfileModal('${f.uid}')">
      <div class="friend-avatar">${f.avatar||'üë§'}<div class="friend-status-dot ${dotCls}"></div></div>
      <div class="friend-info">
        <div class="friend-name">${f.pseudo}</div>
        <div class="friend-activity">${activity || (status === 'online' ? 'En ligne' : 'Hors ligne')}</div>
      </div>
    </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DEMANDES D'AMIS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function listenFriendRequests() {
  db.collection('friendRequests')
    .where('to', '==', currentUser.uid)
    .where('status', '==', 'pending')
    .onSnapshot(snap => {
      const requests = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderFriendRequests(requests);
    });
}

function renderFriendRequests(requests) {
  const countEl = document.getElementById('requests-count');
  countEl.textContent = requests.length;
  countEl.style.display = requests.length ? 'inline-block' : 'none';

  const el = document.getElementById('friend-requests-list');
  if (!requests.length) {
    el.innerHTML = '<div class="comm-empty">Aucune demande en attente</div>';
    return;
  }
  el.innerHTML = requests.map(r => `
    <div class="friend-card">
      <div class="friend-avatar">${r.fromAvatar||'üë§'}</div>
      <div class="friend-info">
        <div class="friend-name">${r.fromPseudo}</div>
        <div class="friend-activity">Veut √™tre votre ami</div>
      </div>
      <div class="friend-actions">
        <button class="friend-btn accept" onclick="acceptFriendRequest('${r.id}','${r.from}','${r.fromPseudo}')" title="Accepter">‚úì</button>
        <button class="friend-btn reject" onclick="rejectFriendRequest('${r.id}')" title="Refuser">‚úï</button>
      </div>
    </div>`).join('');
}

async function sendFriendRequest(toUid, toPseudo) {
  if (toUid === currentUser.uid) return showToast('warning','‚ö†','Erreur','Vous ne pouvez pas vous ajouter vous-m√™me.');
  const friends = currentUserData.friends || [];
  if (friends.includes(toUid)) return showToast('info','‚Ñπ','D√©j√† amis',`Vous √™tes d√©j√† ami avec ${toPseudo}.`);

  // V√©rifier demande existante
  const existing = await db.collection('friendRequests')
    .where('from','==',currentUser.uid)
    .where('to','==',toUid)
    .where('status','==','pending').get();
  if (!existing.empty) return showToast('info','‚Ñπ','Demande envoy√©e',`Vous avez d√©j√† envoy√© une demande √† ${toPseudo}.`);

  await db.collection('friendRequests').add({
    from: currentUser.uid,
    fromPseudo: currentUserData.pseudo,
    fromAvatar: currentUserData.avatar,
    to: toUid, toPseudo, status: 'pending',
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  showToast('success','‚úÖ','Demande envoy√©e',`Demande d'ami envoy√©e √† ${toPseudo} !`);
}

async function acceptFriendRequest(reqId, fromUid, fromPseudo) {
  const batch = db.batch();
  // Ajouter dans les deux sens
  batch.update(db.collection('users').doc(currentUser.uid), {
    friends: firebase.firestore.FieldValue.arrayUnion(fromUid)
  });
  batch.update(db.collection('users').doc(fromUid), {
    friends: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
  });
  batch.update(db.collection('friendRequests').doc(reqId), { status: 'accepted' });
  await batch.commit();
  showToast('success','ü§ù','Ami ajout√© !',`${fromPseudo} est maintenant votre ami.`);
}

async function rejectFriendRequest(reqId) {
  await db.collection('friendRequests').doc(reqId).update({ status: 'rejected' });
  showToast('info','‚úï','Demande refus√©e','');
}

async function removeFriend(uid, pseudo) {
  confirmAction(`Retirer ${pseudo} ?`, `${pseudo} sera retir√© de votre liste d'amis.`, async () => {
    const batch = db.batch();
    batch.update(db.collection('users').doc(currentUser.uid), {
      friends: firebase.firestore.FieldValue.arrayRemove(uid)
    });
    batch.update(db.collection('users').doc(uid), {
      friends: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
    });
    await batch.commit();
    showToast('info','‚úï',`${pseudo} retir√©`,'');
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RECHERCHE UTILISATEURS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let searchTimeout;
async function searchUsers(q) {
  clearTimeout(searchTimeout);
  const el = document.getElementById('find-user-results');
  if (!q || q.length < 2) {
    el.innerHTML = '<div class="comm-empty">Tapez un pseudo pour chercher</div>';
    return;
  }
  searchTimeout = setTimeout(async () => {
    const snap = await db.collection('users')
      .where('pseudoLower','>=',q.toLowerCase())
      .where('pseudoLower','<=',q.toLowerCase()+'\uf8ff')
      .limit(8).get();

    if (snap.empty) {
      el.innerHTML = '<div class="comm-empty">Aucun utilisateur trouv√©</div>';
      return;
    }

    const friends = currentUserData.friends || [];
    el.innerHTML = snap.docs.map(d => {
      const u = d.data();
      if (u.uid === currentUser.uid) return '';
      const isFriend = friends.includes(u.uid);
      return `<div class="find-user-result">
        <div class="friend-avatar" style="width:32px;height:32px;font-size:14px;background:var(--surface);border:1px solid var(--border)">${u.avatar||'üë§'}</div>
        <div style="flex:1;min-width:0">
          <div style="font-size:13px;font-weight:700">${u.pseudo}</div>
          <div style="font-size:10px;color:var(--muted);font-family:'Inter'">${(u.installedApps||[]).length} apps</div>
        </div>
        ${isFriend
          ? `<span style="font-size:10px;color:var(--success);font-family:'Inter'">‚úì Ami</span>`
          : `<button class="add-friend-btn" onclick="sendFriendRequest('${u.uid}','${u.pseudo}')">+ Ajouter</button>`}
      </div>`;
    }).join('');
  }, 400);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROFILE MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let viewingUid = null;

async function openProfileModal(uid) {
  viewingUid = uid;
  const snap = await db.collection('users').doc(uid).get();
  if (!snap.exists) return;
  const u = snap.data();

  document.getElementById('pm-avatar').textContent = u.avatar || 'üë§';
  document.getElementById('pm-name').textContent   = u.pseudo;

  // Pr√©sence
  rtdb.ref(`presence/${uid}`).once('value', s => {
    const p = s.val() || {};
    const isOnline = p.status === 'online';
    const dot = document.getElementById('pm-dot');
    dot.className = `status-indicator ${isOnline ? 'status-online' : 'status-offline'}`;
    document.getElementById('pm-status-text').textContent = isOnline ? (p.activity || 'En ligne') : 'Hors ligne';
  });

  // Stats
  const installed = u.installedApps || [];
  const ratings   = u.ratings || {};
  const friends   = u.friends || [];
  document.getElementById('pm-apps-count').textContent    = installed.length;
  document.getElementById('pm-friends-count').textContent = friends.length;
  document.getElementById('pm-rating-count').textContent  = Object.keys(ratings).length;

  // Apps grid
  const appsGrid = document.getElementById('pm-apps-grid');
  if (installed.length) {
    appsGrid.innerHTML = installed.map(appId => {
      const app = allApps.find(a => a.id === appId);
      if (!app) return '';
      return `<div class="pm-app-badge">
        <img src="${app.image||''}" onerror="this.style.display='none'" alt=""/>
        ${app.name}
      </div>`;
    }).join('');
  } else {
    appsGrid.innerHTML = '<span style="font-size:11px;color:var(--muted);font-family:Inter">Aucune app visible</span>';
  }

  // Actions
  const myFriends = currentUserData.friends || [];
  const isFriend  = myFriends.includes(uid);
  const isMe      = uid === currentUser.uid;
  const actionsEl = document.getElementById('pm-actions');
  if (isMe) {
    actionsEl.innerHTML = `<span style="font-size:12px;color:var(--muted);font-family:'Inter'">C'est votre profil</span>`;
  } else if (isFriend) {
    actionsEl.innerHTML = `
      <button class="btn btn-uninstall" style="flex:0;padding:8px 16px" onclick="removeFriend('${uid}','${u.pseudo}');closeProfileModal()">Retirer</button>`;
  } else {
    actionsEl.innerHTML = `
      <button class="btn btn-install" style="flex:0;padding:8px 16px" onclick="sendFriendRequest('${uid}','${u.pseudo}');closeProfileModal()">+ Ajouter</button>`;
  }

  document.getElementById('profile-modal-overlay').classList.add('open');
}

function openMyProfile() { if (currentUser) openProfileModal(currentUser.uid); }
function closeProfileModal(e) {
  if (!e || e.target === document.getElementById('profile-modal-overlay'))
    document.getElementById('profile-modal-overlay').classList.remove('open');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RATINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentModalAppId = null;

async function loadAppRating(appId) {
  const snap = await db.collection('ratings').doc(appId).get();
  const data = snap.data() || { total: 0, count: 0, users: {} };
  const avg  = data.count > 0 ? (data.total / data.count).toFixed(1) : '‚Äî';
  const stars = data.count > 0 ? '‚òÖ'.repeat(Math.round(data.total/data.count)) + '‚òÜ'.repeat(5-Math.round(data.total/data.count)) : '‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ';

  document.getElementById('modal-avg').textContent   = avg;
  document.getElementById('modal-stars').textContent = stars;
  document.getElementById('modal-count').textContent = `${data.count} avis`;

  // Note de l'utilisateur
  const myRating = data.users?.[currentUser.uid] || 0;
  document.querySelectorAll('#modal-user-stars span').forEach((s,i) => {
    s.classList.toggle('active', i < myRating);
  });
}

async function rateApp(stars) {
  if (!currentModalAppId || !currentUser) return;
  const ref  = db.collection('ratings').doc(currentModalAppId);
  const snap = await ref.get();
  const data = snap.data() || { total: 0, count: 0, users: {} };
  const prev = data.users?.[currentUser.uid] || 0;

  await ref.set({
    total: (data.total - prev + stars),
    count: prev === 0 ? data.count + 1 : data.count,
    users: { ...data.users, [currentUser.uid]: stars }
  }, { merge: true });

  // Sauvegarder dans profil user
  await db.collection('users').doc(currentUser.uid).update({
    [`ratings.${currentModalAppId}`]: stars
  });
  document.getElementById('my-ratings-count').textContent =
    Object.keys((await db.collection('users').doc(currentUser.uid).get()).data()?.ratings || {}).length;

  document.querySelectorAll('#modal-user-stars span').forEach((s,i) => {
    s.classList.toggle('active', i < stars);
  });
  loadAppRating(currentModalAppId);
  showToast('success','‚≠ê',`Note enregistr√©e`,`Vous avez mis ${stars}/5 √† cette app.`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STORE ‚Äî STATE & INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let allApps = [];
let activeCategory = 'Tous';
let installedState = {};
let queue = [];
let isProcessingQueue = false;

async function initLauncher() {
  allApps = await window.launcher.getApps();
  const ver = await window.launcher.getVersion();
  document.getElementById('app-count').textContent = `${allApps.length} apps`;
  buildCategoryUI();
  renderGrid(filterCurrent());
  listenProgress();
  listenUpdate();
  scanInstalledApps();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SCAN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function scanInstalledApps() {
  const spin  = document.getElementById('scan-spin');
  const label = document.getElementById('scan-label');
  spin.classList.add('visible'); label.textContent = 'Scan...';
  try {
    installedState = await window.launcher.checkAllInstalled();
  } catch(e) { installedState = {}; }
  spin.classList.remove('visible'); label.textContent = '';
  updateInstalledCount();
  syncInstalledToFirebase();
  renderGrid(filterCurrent());
}

async function rescanAllApps() {
  showToast('info','üîç','Scan en cours','D√©tection des applications...');
  await scanInstalledApps();
  showToast('success','‚úÖ','Scan termin√©',`${Object.values(installedState).filter(Boolean).length} app(s) d√©tect√©e(s).`);
}

function updateInstalledCount() {
  const count = Object.values(installedState).filter(Boolean).length;
  document.getElementById('installed-count').textContent = count > 0 ? `‚úì ${count} install√©e${count>1?'s':''}` : '';
  document.getElementById('cp-apps').textContent = count;
  document.getElementById('my-apps-count').textContent  = count;
}

async function syncInstalledToFirebase() {
  if (!currentUser) return;
  const installedIds = Object.keys(installedState).filter(id => installedState[id]);
  await db.collection('users').doc(currentUser.uid).update({ installedApps: installedIds });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CATEGORIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildCategoryUI() {
  const cats = ['Tous', ...new Set(allApps.map(a => a.category))];
  document.getElementById('cat-tabs').innerHTML = cats.map(c =>
    `<button class="cat-tab ${c==='Tous'?'active':''}" onclick="selectCategory('${c}')">${c}</button>`
  ).join('');
  document.getElementById('sidebar-cats').innerHTML = cats.slice(1).map(c =>
    `<button class="nav-item" onclick="selectCategory('${c}')">¬∑ ${c}</button>`
  ).join('');
}

function selectCategory(cat) {
  activeCategory = cat;
  document.querySelectorAll('.cat-tab').forEach(b => b.classList.toggle('active', b.textContent === cat));
  filterApps();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILTER & RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function filterApps() { renderGrid(filterCurrent()); }
function filterCurrent() {
  const q = document.getElementById('search').value.toLowerCase();
  return allApps.filter(a => {
    const mc = activeCategory === 'Tous' || a.category === activeCategory;
    const ms = !q || a.name.toLowerCase().includes(q) || a.description.toLowerCase().includes(q) || (a.tags||[]).some(t=>t.toLowerCase().includes(q));
    return mc && ms;
  });
}

function renderGrid(apps) {
  document.getElementById('app-count').textContent = `${apps.length} app${apps.length!==1?'s':''}`;
  const grid = document.getElementById('grid');
  if (!apps.length) {
    grid.innerHTML = `<div class="empty-state"><h3>Aucune application trouv√©e</h3><p>Essayez une autre recherche.</p></div>`;
    return;
  }
  grid.innerHTML = apps.map((app,i) => buildCard(app,i)).join('');
}

function buildCard(app, i=0) {
  const qi          = queue.find(q => q.id === app.id);
  const isInstalled = installedState[app.id] === true;
  const isInstalling= qi && qi.status === 'installing';
  const isInQueue   = qi && qi.status === 'waiting';
  const isDone      = qi && qi.status === 'done';
  const isError     = qi && qi.status === 'error';
  const progress    = qi ? qi.progress : 0;
  const statusText  = qi ? (qi.statusText || '') : '';
  const showProg    = isInstalling || isInQueue || isError;
  const hasUrl      = !!app.downloadUrl;
  const hasCmd      = !!app.installCommand;

  // Image avec fallback
  const imgHtml = app.image
    ? `<img src="${app.image}" alt="${app.name}" loading="lazy"
         onerror="this.src='';this.style.display='none';this.nextElementSibling.style.display='flex'"/>
       <span style="display:none;font-family:'Bebas Neue';font-size:32px;color:rgba(255,255,255,.1);position:absolute">${app.name.substring(0,2).toUpperCase()}</span>`
    : `<span style="font-family:'Bebas Neue';font-size:32px;color:rgba(255,255,255,.1)">${app.name.substring(0,2).toUpperCase()}</span>`;

  let footerHtml = '';
  if (isInstalling) {
    footerHtml = `<button class="btn btn-cancel" onclick="cancelInstall('${app.id}')">‚úï Annuler (${progress}%)</button><button class="btn btn-sm" onclick="openModal('${app.id}')">‚Ñπ</button>`;
  } else if (isInQueue) {
    footerHtml = `<button class="btn btn-cancel" style="background:rgba(255,215,64,.08);border-color:rgba(255,215,64,.3);color:var(--warning)" onclick="removeFromQueue('${app.id}')">‚è≥ Attente ¬∑ Annuler</button><button class="btn btn-sm" onclick="openModal('${app.id}')">‚Ñπ</button>`;
  } else if (isInstalled) {
    footerHtml = `<button class="btn btn-launch" onclick="launchApp('${app.id}')">‚ñ∂ Lancer</button><button class="btn btn-uninstall btn-sm" onclick="confirmUninstall('${app.id}')" title="D√©sinstaller">üóë</button><button class="btn btn-sm" onclick="openModal('${app.id}')">‚Ñπ</button>`;
  } else if (hasUrl || hasCmd) {
    footerHtml = `<button class="btn btn-install" onclick="addToQueue('${app.id}')">‚Üì Installer</button><button class="btn btn-sm" onclick="openModal('${app.id}')">‚Ñπ</button>`;
  } else {
    footerHtml = `<button class="btn btn-install" disabled>Non disponible</button><button class="btn btn-sm" onclick="openModal('${app.id}')">‚Ñπ</button>`;
  }

  return `<div class="app-card ${isInstalled?'installed':''}" style="animation-delay:${i*30}ms" id="card-${app.id}">
    <div class="card-img" onclick="openModal('${app.id}')">
      ${imgHtml}
      <span class="card-cat-badge">${app.category}</span>
      <span class="installed-badge">‚úì Install√©</span>
    </div>
    <div class="card-body">
      <div class="card-name">${app.name}</div>
      <div class="card-desc">${app.description}</div>
      <div class="card-rating" id="rating-${app.id}">
        <span class="stars">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</span>
        <span class="rating-count">Chargement...</span>
      </div>
      <div class="card-progress ${showProg||isError?'visible':''}" id="prog-${app.id}">
        <div class="progress-bar"><div class="progress-fill ${isDone?'done':''} ${isError?'err':''}" id="fill-${app.id}" style="width:${progress}%"></div></div>
        <div class="progress-text"><span id="ptext-${app.id}">${statusText}</span><span id="ppct-${app.id}">${progress}%</span></div>
      </div>
      <div class="card-footer" id="footer-${app.id}">${footerHtml}</div>
    </div>
  </div>`;
}

function refreshCard(id) {
  const app  = allApps.find(a => a.id === id);
  const card = document.getElementById(`card-${id}`);
  if (!app || !card) return;
  const idx = [...document.getElementById('grid').children].indexOf(card);
  card.outerHTML = buildCard(app, idx);
  loadCardRating(id);
}

async function loadCardRating(appId) {
  const el = document.getElementById(`rating-${appId}`);
  if (!el) return;
  try {
    const snap = await db.collection('ratings').doc(appId).get();
    const data = snap.data() || { total: 0, count: 0 };
    if (data.count > 0) {
      const avg  = (data.total / data.count).toFixed(1);
      const full = Math.round(data.total / data.count);
      el.innerHTML = `<span class="stars">${'‚òÖ'.repeat(full)}${'‚òÜ'.repeat(5-full)}</span><span class="rating-count">${avg} (${data.count})</span>`;
    } else {
      el.innerHTML = `<span class="stars" style="color:rgba(255,255,255,.15)">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</span><span class="rating-count">Pas encore not√©</span>`;
    }
  } catch(e) { el.innerHTML = ''; }
}

function loadAllRatings() {
  allApps.forEach(app => loadCardRating(app.id));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// QUEUE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addToQueue(id) {
  const app = allApps.find(a => a.id === id);
  if (!app) return;
  if (queue.find(q => q.id === id && (q.status==='waiting'||q.status==='installing'))) {
    showToast('warning','‚è≥','D√©j√† en file',`${app.name} est d√©j√† dans la file.`); return;
  }
  const old = queue.findIndex(q => q.id === id);
  if (old !== -1) queue.splice(old, 1);
  queue.push({ id, name: app.name, status: 'waiting', progress: 0, statusText: 'En attente...' });
  showToast('info','üì•','Ajout√© √† la file',`${app.name} sera install√© prochainement.`);
  renderQueue(); refreshCard(id); processQueue();
}

function removeFromQueue(id) {
  const idx = queue.findIndex(q => q.id === id && q.status === 'waiting');
  if (idx !== -1) { queue.splice(idx,1); renderQueue(); refreshCard(id); }
}

async function processQueue() {
  if (isProcessingQueue) return;
  const next = queue.find(q => q.status === 'waiting');
  if (!next) { isProcessingQueue = false; return; }
  isProcessingQueue = true;
  next.status = 'installing'; next.progress = 0;
  renderQueue(); refreshCard(next.id);

  const app = allApps.find(a => a.id === next.id);
  let result;
  try {
    if (app.downloadUrl)      result = await window.launcher.installUrl(app);
    else if (app.installCommand) result = await window.launcher.installCommand(app);
    else result = { success: false, message: 'Aucune m√©thode.' };
  } catch(e) { result = { success: false, message: e.message }; }

  if (result.cancelled) {
    next.status = 'cancelled'; next.statusText = 'Annul√©';
  } else if (result.success) {
    next.status = 'done'; next.progress = 100; next.statusText = 'Install√© !';
    installedState[next.id] = true;
    updateInstalledCount(); syncInstalledToFirebase();
    showToast('success','‚úÖ',`${app.name} install√© !`,'');
  } else {
    next.status = 'error'; next.statusText = result.message || 'Erreur';
    showToast('error','‚ùå',`√âchec : ${app.name}`, result.message);
  }
  renderQueue(); refreshCard(next.id);
  isProcessingQueue = false; processQueue();
}

function renderQueue() {
  const active  = queue.filter(q => q.status !== 'cancelled');
  const pending = active.filter(q => q.status==='waiting'||q.status==='installing').length;
  const countEl = document.getElementById('queue-count');
  countEl.textContent = pending; countEl.classList.toggle('visible', pending > 0);

  if (!active.length) { document.getElementById('queue-list').innerHTML='<div class="queue-empty">Aucune installation</div>'; return; }
  document.getElementById('queue-list').innerHTML = active.map(q => {
    const cls   = {waiting:'badge-waiting',installing:'badge-installing',done:'badge-done',error:'badge-error'}[q.status]||'';
    const label = {waiting:'Attente',installing:'En cours',done:'OK',error:'Erreur'}[q.status]||'';
    const fill  = q.status==='done'?' done':q.status==='error'?' error':'';
    const cancelBtn = q.status==='waiting' ? `<button class="q-cancel" onclick="removeFromQueue('${q.id}')">‚úï</button>`
      : q.status==='installing' ? `<button class="q-cancel" onclick="cancelInstall('${q.id}')" style="color:var(--error)">‚úï</button>` : '';
    return `<div class="queue-item">
      <div class="queue-item-name"><span class="q-name-text">${q.name}</span><span class="queue-status-badge ${cls}">${label}</span>${cancelBtn}</div>
      <div class="mini-progress"><div class="mini-fill${fill}" style="width:${q.progress}%"></div></div>
    </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CANCEL / UNINSTALL / LAUNCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function cancelInstall(id) {
  const qi = queue.find(q => q.id === id);
  if (!qi) return;
  window.launcher.cancelDownload(id);
  await window.launcher.cancelInstall(id);
  qi.status = 'cancelled'; qi.statusText = 'Annul√©';
  showToast('warning','‚úï','Annul√©', qi.name);
  renderQueue(); refreshCard(id);
  isProcessingQueue = false; processQueue();
}

let confirmCb = null;
function confirmAction(title, msg, cb) {
  document.getElementById('confirm-title').textContent = title;
  document.getElementById('confirm-msg').textContent   = msg;
  confirmCb = cb;
  document.getElementById('confirm-yes-btn').onclick = () => { closeConfirm(); confirmCb(); };
  document.getElementById('confirm-overlay').classList.add('open');
}
function closeConfirm() { document.getElementById('confirm-overlay').classList.remove('open'); confirmCb = null; }

function confirmUninstall(id) {
  const app = allApps.find(a => a.id === id);
  if (!app) return;
  confirmAction(`D√©sinstaller ${app.name} ?`, `${app.name} sera supprim√© de votre syst√®me.`, () => doUninstall(id));
}

async function doUninstall(id) {
  const app = allApps.find(a => a.id === id);
  if (!app) return;
  showToast('info','üóë',`D√©sinstallation de ${app.name}`,'Veuillez patienter...');
  installedState[id] = false; updateInstalledCount(); refreshCard(id);
  const result = await window.launcher.uninstallApp(app);
  if (result.success) {
    showToast('success','‚úÖ',`${app.name} d√©sinstall√©`,result.message);
    syncInstalledToFirebase();
  } else {
    showToast('error','‚ùå','√âchec d√©sinstallation',result.message);
    const check = await window.launcher.checkInstalled(app);
    installedState[id] = check.installed;
  }
  updateInstalledCount(); refreshCard(id);
}

async function launchApp(id) {
  const app = allApps.find(a => a.id === id);
  if (!app) return;
  // Mettre √† jour le statut "joue √†"
  if (app.category === 'Jeux') {
    await setOnlineStatus(currentUser.uid, 'online', `Joue √† ${app.name}`);
    setTimeout(() => setOnlineStatus(currentUser.uid, 'online', ''), 3600000);
  }
  const result = await window.launcher.launchApp(app);
  if (!result.success) showToast('error','‚ùå','√âchec du lancement',result.message);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROGRESS LISTENER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function listenProgress() {
  window.launcher.onProgress(({ id, progress, status }) => {
    const qi = queue.find(q => q.id === id);
    if (qi) { qi.progress = progress; if (status) qi.statusText = status; }
    const fill   = document.getElementById(`fill-${id}`);
    const ptext  = document.getElementById(`ptext-${id}`);
    const ppct   = document.getElementById(`ppct-${id}`);
    const prog   = document.getElementById(`prog-${id}`);
    const footer = document.getElementById(`footer-${id}`);
    if (fill)   fill.style.width = progress + '%';
    if (ptext && status) ptext.textContent = status;
    if (ppct)   ppct.textContent = progress + '%';
    if (prog)   prog.classList.add('visible');
    if (footer) { const btn = footer.querySelector('.btn-cancel'); if (btn) btn.textContent = `‚úï Annuler (${progress}%)`; }
    renderQueue();
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODAL APP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModal(id) {
  const app = allApps.find(a => a.id === id);
  if (!app) return;
  currentModalAppId = id;
  const isInstalled = installedState[app.id] === true;
  document.getElementById('modal-title').textContent = app.name;
  document.getElementById('modal-installed-chip').classList.toggle('visible', isInstalled);
  const img = document.getElementById('modal-img');
  img.src = app.image || ''; img.style.display = app.image ? 'block' : 'none';
  document.getElementById('modal-desc').textContent = app.description;
  document.getElementById('modal-row').innerHTML = [
    app.version  ? `<div class="modal-info"><div class="modal-info-label">Version</div><div class="modal-info-val">${app.version}</div></div>` : '',
    app.size     ? `<div class="modal-info"><div class="modal-info-label">Taille</div><div class="modal-info-val">${app.size}</div></div>` : '',
    app.category ? `<div class="modal-info"><div class="modal-info-label">Cat√©gorie</div><div class="modal-info-val">${app.category}</div></div>` : '',
  ].join('');
  document.getElementById('modal-tags').innerHTML = [app.category,...(app.tags||[])].map(t=>`<span class="tag">${t}</span>`).join('');
  const qi = queue.find(q => q.id === id);
  const inQ = qi && (qi.status==='waiting'||qi.status==='installing');
  document.getElementById('modal-actions').innerHTML = isInstalled
    ? `<button class="btn btn-launch" onclick="launchApp('${app.id}');closeModal()">‚ñ∂ Lancer</button>
       <button class="btn btn-uninstall" onclick="closeModal();confirmUninstall('${app.id}')">üóë D√©sinstaller</button>
       ${app.website?`<button class="btn btn-sm" onclick="window.launcher.openUrl('${app.website}')">üîó</button>`:''}`
    : inQ
      ? `<button class="btn btn-cancel" onclick="cancelInstall('${app.id}');closeModal()">‚úï Annuler</button>`
      : `<button class="btn btn-install" onclick="addToQueue('${app.id}');closeModal()">‚Üì Installer</button>
         ${app.website?`<button class="btn btn-sm" onclick="window.launcher.openUrl('${app.website}')">üîó</button>`:''}`;
  loadAppRating(id);
  document.getElementById('modal-overlay').classList.add('open');
}
function closeModal(e) {
  if (!e || e.target===document.getElementById('modal-overlay'))
    document.getElementById('modal-overlay').classList.remove('open');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setPage(page, btn) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
  document.getElementById(`page-${page}`).classList.add('active');
  if (btn) btn.classList.add('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UPDATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function listenUpdate() {
  window.launcher.onUpdateAvailable(({ remoteVersion, currentVersion, releaseUrl }) => {
    document.getElementById('update-new-ver').textContent = 'v' + remoteVersion;
    document.getElementById('btn-do-update').onclick = () => window.launcher.openUrl(releaseUrl);
    document.getElementById('update-banner').classList.add('visible');
  });
}

async function checkUpdateManual() {
  showToast('info','üîç','V√©rification...','');
  const r = await window.launcher.checkUpdate();
  if (r.error) showToast('error','‚ùå','Impossible de v√©rifier','');
  else if (r.hasUpdate) showToast('success','üöÄ',`v${r.remoteVersion} disponible !`,'Banni√®re mise √† jour affich√©e.');
  else showToast('success','‚úÖ','Launcher √† jour !',`v${r.currentVersion}`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showToast(type, icon, title, msg) {
  const c = document.getElementById('toast-container');
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.innerHTML = `<div class="toast-icon">${icon}</div><div class="toast-content"><div class="toast-title">${title}</div>${msg?`<div class="toast-msg">${msg}</div>`:''}</div>`;
  c.appendChild(t);
  setTimeout(() => { t.style.opacity='0'; t.style.transition='opacity .3s'; setTimeout(()=>t.remove(),300); }, 4500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BOOT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
buildAvatarGrid();

if (initFirebase()) {
  auth.onAuthStateChanged(user => {
    if (user) {
      onUserLoggedIn(user);
    } else {
      document.getElementById('auth-overlay').classList.remove('hidden');
    }
  });
}

// Charger les notes apr√®s que la grille soit rendue
setTimeout(loadAllRatings, 2000);
</script>
</body>
</html>
